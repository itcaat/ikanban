import { getSupabaseClient, assertAuth, jsonResponse } from "../_shared/supabase.ts";
import { getCurrentTournamentId, getPreviousTournamentId, formatDateRange } from "../_shared/tournament.ts";
import { sendTelegram, formatLeaderboard, pickRandom } from "../_shared/telegram.ts";
import { fetchTop, countPlayers } from "../_shared/queries.ts";

const SARCASTIC_INTROS = [
  "ĞŸĞ¾ĞºĞ° Ğ²Ñ‹ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°Ğ»Ğ¸, ĞºÑ‚Ğ¾-Ñ‚Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ğ» Ñ‚Ğ°ÑĞºĞ¸. Ğ˜Ñ‚Ğ¾Ğ³Ğ¸:",
  "Ğ•Ñ‰Ñ‘ Ğ¾Ğ´Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ, ĞµÑ‰Ñ‘ Ğ¾Ğ´Ğ¸Ğ½ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€, ĞµÑ‰Ñ‘ Ğ¾Ğ´Ğ¸Ğ½ Ğ±ÑĞºĞ»Ğ¾Ğ³, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½Ğ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ».",
  "HR Ğ¿Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ¾ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸. Ğ’Ğ¾Ñ‚ Ğ¾Ğ½:",
  "Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹ Ğ·Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚Ğ°ÑĞºĞ¾Ğ² Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»Ğ¸ â€” ÑÑ‚Ğ¸ Ğ»ÑĞ´Ğ¸ ÑƒĞ¶Ğµ ÑƒĞ²Ğ¾Ğ»Ğ¸Ğ»Ğ¸ÑÑŒ Ğ±Ñ‹.",
  "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ·Ğ°Ğ±ĞµĞ³Ğ° Ğ¿Ğ¾ ĞºĞ°Ğ½Ğ±Ğ°Ğ½-Ğ´Ğ¾ÑĞºĞµ. Ğ¡Ğ¿Ğ¾Ğ¹Ğ»ĞµÑ€: Ğ±ÑĞºĞ»Ğ¾Ğ³ Ğ¾Ğ¿ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ».",
  "ĞœĞ¸Ğ½ÑƒÑ‚Ğ° Ğ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ·Ğ° Ğ²ÑĞµÑ…, Ñ‡ĞµĞ¹ HP Ğ´Ğ¾ÑˆÑ‘Ğ» Ğ´Ğ¾ Ğ½ÑƒĞ»Ñ.",
  "ĞšÑ‚Ğ¾-Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµÑ‚Ğ°ÑĞºĞ¸Ğ²Ğ°Ğ» ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ»ÑƒÑ‡ÑˆĞµ Ğ²ÑĞµÑ…. Ğ ĞºÑ‚Ğ¾-Ñ‚Ğ¾ â€” Ğ½ĞµÑ‚. Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ±ĞµÑĞ¿Ğ¾Ñ‰Ğ°Ğ´Ğ½Ğ°.",
  "ĞŸÑÑ‚Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ÑˆÑ‘Ğ». ĞĞµ Ğ²ÑĞµ Ğ²Ñ‹Ğ¶Ğ¸Ğ»Ğ¸. Ğ’Ğ¾Ñ‚ ĞºÑ‚Ğ¾ ÑĞ¼Ğ¾Ğ³:",
  "Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸: Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹, ĞºĞ¾Ñ„Ğµ Ğ²Ñ‹Ğ¿Ğ¸Ñ‚, Ğ½ĞµÑ€Ğ²Ñ‹ ÑĞ¾Ğ¶Ğ¶ĞµĞ½Ñ‹.",
  "Ğ‘ÑĞºĞ»Ğ¾Ğ³ Ğ½Ğµ Ğ¶Ğ´Ñ‘Ñ‚. ĞĞ¾ ÑÑ‚Ğ¸ Ğ³ĞµÑ€Ğ¾Ğ¸ Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ¿Ñ‹Ñ‚Ğ°Ğ»Ğ¸ÑÑŒ.",
  "Ğ¢Ğ¾Ğ¿-Ğ¼ĞµĞ½ĞµĞ´Ğ¶Ğ¼ĞµĞ½Ñ‚ Ğ´Ğ¾Ğ²Ğ¾Ğ»ĞµĞ½. Ğ¨ÑƒÑ‚ĞºĞ°. ĞĞ¾ Ğ²Ğ¾Ñ‚ ĞºÑ‚Ğ¾ ÑÑ‚Ğ°Ñ€Ğ°Ğ»ÑÑ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµÑ…:",
  "Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚. Ğ ĞµÑ‚Ñ€Ğ¾ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾. Ğ’Ğ¾Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:",
  "ĞÑ‡ĞµÑ€ĞµĞ´Ğ½Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ Ğ² Ğ¼Ğ¸Ñ€Ğµ IT. ĞšÑ‚Ğ¾-Ñ‚Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ» Ğ² Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ñƒ, ĞºÑ‚Ğ¾-Ñ‚Ğ¾ â€” Ğ¸Ğ³Ñ€Ğ°Ğ» Ğ² iKanban.",
  "Ğ”ĞµĞ¹Ğ»Ğ¸-ÑÑ‚ĞµĞ½Ğ´Ğ°Ğ¿ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡ĞµĞ½. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğº Ğ²Ğ°Ğ¶Ğ½Ğ¾Ğ¼Ñƒ â€” Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³!",
  "Ğ­Ñ‚Ğ¸Ñ… Ğ»ÑĞ´ĞµĞ¹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¼ĞµĞ»Ğ¾ ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¸Ğ¼Ğ»Ğ¸Ğ´Ğ°Ğ¼Ğ¸. Ğ˜Ğ»Ğ¸ Ğ½ĞµÑ‚. ĞĞ¾ Ñ‚Ğ°ÑĞºĞ¸ Ğ¾Ğ½Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‚.",
  "ĞšĞ°Ğ½Ğ±Ğ°Ğ½-Ğ´Ğ¾ÑĞºĞ° Ğ¿ÑƒÑÑ‚Ğ°... Ğ¨ÑƒÑ‚ĞºĞ°. ĞĞ½Ğ° Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ°. ĞĞ¾ Ğ²Ğ¾Ñ‚ ĞºÑ‚Ğ¾ Ğ¿Ñ‹Ñ‚Ğ°Ğ»ÑÑ:",
  "ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ´Ğ»Ñ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ Ğ½Ğµ Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ° ÑÑ‚ĞµĞ½Ğ´Ğ°Ğ¿Ñ‹:",
  "Ğ¡ĞµĞºÑ â€” ÑÑ‚Ğ¾ ĞºÑ€ÑƒÑ‚Ğ¾, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ğ»Ğ¸ Ğ»Ğ¸ Ğ²Ñ‹ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ°ÑĞºĞ¸? Ğ­Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ğ»Ğ¸:",
  "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ±ĞµĞ³Ğ°. ĞŸÑ€Ğ¸Ğ·Ñ‹ â€” Ğ´Ğ¾Ñ„Ğ°Ğ¼Ğ¸Ğ½ Ğ¸ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ»Ğ³Ğ°.",
  "Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¾Ğ¹. Ğ‘ÑĞºĞ»Ğ¾Ğ³ Ğ°Ñ‚Ğ°ĞºÑƒĞµÑ‚, Ğ½Ğ¾ Ğ¼Ñ‹ Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼ÑÑ.",
];

Deno.serve(async (req) => {
  try {
    assertAuth(req);
    const supabase = getSupabaseClient();

    const prevId = getPreviousTournamentId();
    const prevRange = formatDateRange(prevId);
    const currentRange = formatDateRange(getCurrentTournamentId());

    const top10 = await fetchTop(supabase, prevId, 10);
    const total = await countPlayers(supabase, prevId);

    let message = `${pickRandom(SARCASTIC_INTROS)}\n\nğŸ† <b>Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ°</b>\nğŸ“… ${prevRange}\n\n`;

    if (top10.length > 0) {
      message += formatLeaderboard(top10);
      message += `\n\nĞ’ÑĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²: ${total}`;
    } else {
      message += "ĞĞ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¸Ğ³Ñ€Ğ°Ğ». Ğ“Ñ€ÑƒÑÑ‚Ğ½Ğ¾. ğŸ˜¢";
    }

    message += `\n\nğŸš€ <b>ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑÑ!</b>\nğŸ“… ${currentRange}\nğŸ® Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ: <a href="https://ikanban.ru">ikanban.ru</a>`;

    const result = await sendTelegram(message);
    return jsonResponse(result, result.ok ? 200 : 500);
  } catch (err) {
    const msg = String(err);
    if (msg.includes("Unauthorized")) return new Response("Unauthorized", { status: 401 });
    return jsonResponse({ error: msg }, 500);
  }
});
